---
import type { ComponentProps } from "astro/types";
import ButtonAnchor from "@/components/Button/ButtonAnchor.astro";
import { pathHasLocale, normalizePath, neutralizePath } from "@/utils";
import { getRelativeLocaleUrl } from "astro:i18n";

interface Props extends ComponentProps<typeof ButtonAnchor> {
  localized?: boolean;
}

const { localized = false, ...attributes } = Astro.props;

const base = Astro.site ?? Astro.url.origin;
const baseUrl = new URL(base);
const linkUrl = new URL(attributes.href ?? "", base);

const isInternal = linkUrl.origin === baseUrl.origin;

if (isInternal) {
  const rawPath = linkUrl.pathname;

  const finalPath =
    localized || pathHasLocale(rawPath)
      ? rawPath
      : getRelativeLocaleUrl(Astro.currentLocale, rawPath);

  const href = normalizePath(finalPath + linkUrl.search + linkUrl.hash);

  // ---- aria-current ----
  const currentPath = neutralizePath(Astro.url.pathname);

  const linkPath = neutralizePath(finalPath);

  const isCurrent =
    currentPath === linkPath || (linkPath !== "/" && currentPath.startsWith(linkPath));

  attributes["aria-current"] = isCurrent ? "page" : undefined;
  attributes["href"] = href;
}
---

<ButtonAnchor variant="ghost" size="m" {...attributes}>
  <slot />
</ButtonAnchor>

---
import type { ComponentProps } from "astro/types";
import ButtonAnchor from "./Button/ButtonAnchor.astro";

import { getLangFromUrl } from "@/utils/common/locale";
import {
  localizePath,
  stripLangFromUrlOrId,
  ensureTrailingSlash,
  ensureLeadingSlash,
  collapseSlashes
} from "@/utils/common/path";

interface Props extends ComponentProps<typeof ButtonAnchor> {
  localized?: boolean;
}

const { localized = false, ...attributes } = Astro.props;

const base = Astro.site ?? Astro.url.origin;
const baseUrl = new URL(base);
const linkUrl = new URL(attributes.href ?? "", base);

const isInternal = linkUrl.origin === baseUrl.origin;

let href = attributes.href;

if (isInternal) {
  const curLang = getLangFromUrl(Astro.url);

  const rawPath = linkUrl.pathname;
  const hasLocale = stripLangFromUrlOrId(rawPath) !== rawPath;

  const finalPath = localized || hasLocale ? rawPath : localizePath(curLang, rawPath);

  href = collapseSlashes(ensureLeadingSlash(finalPath) + linkUrl.search + linkUrl.hash);

  // ---- aria-current ----
  const currentPath = ensureTrailingSlash(stripLangFromUrlOrId(Astro.url.pathname));

  const linkPath = ensureTrailingSlash(stripLangFromUrlOrId(finalPath));

  const isCurrent =
    currentPath === linkPath || (linkPath !== "/" && currentPath.startsWith(linkPath));

  attributes["aria-current"] = isCurrent ? "page" : undefined;
}

attributes.href = href;
---

<ButtonAnchor variant="ghost" size="m" {...attributes}>
  <slot />
</ButtonAnchor>

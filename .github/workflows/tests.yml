name: Tests

on:
  push:
  pull_request:

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      NODE_ENV: test
      FORCE_HTTP: true
      ASTRO_TELEMETRY_DISABLED: 1
      E2E_BASE_URL: "http://127.0.0.1:4321"
      PUPPETEER_CACHE_DIR: ${{ github.workspace }}/.cache/puppeteer
      SITE_NAME: "Scholar's Astrolabe"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn
        run: corepack enable

      # Cache Yarn artifacts (Yarn Berry)
      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
            .yarn/unplugged
            .yarn/build-state.yml
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      # --- Build + Serve dist ---
      - name: Build site
        run: yarn build

      - name: Serve dist
        run: yarn astro preview --site "$E2E_BASE_URL" &

      - name: Wait for server
        run: yarn wait-on -t 5m "$E2E_BASE_URL"

      # --- Link checker on the built HTML ---
      - name: Link checker
        uses: lycheeverse/lychee-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >-
            --no-progress
            --verbose
            --max-retries 2
            --max-concurrency 10
            --base-url ${{ env.E2E_BASE_URL }}
            --exclude "${{ env.E2E_BASE_URL }}/[a-z]{2}/test/?$"
            "dist/**/*.html"
          fail: true

      # --- A11y ---
      # Ensure Puppeteer cache dir exists and cache it
      - name: Prepare Puppeteer cache dir
        run: mkdir -p "$PUPPETEER_CACHE_DIR"

      - name: Cache Puppeteer browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PUPPETEER_CACHE_DIR }}
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-puppeteer-

      - name: Install Chrome for Testing (Pa11y/Puppeteer)
        run: yarn dlx @puppeteer/browsers install chrome@stable --path "$PUPPETEER_CACHE_DIR"

      - name: Export Chrome path for Puppeteer
        shell: bash
        run: |
          set -euo pipefail
          CHROME_PATH="$(find "$PUPPETEER_CACHE_DIR" -type f -executable -name 'chrome' -print -quit || true)"
          if [ -z "${CHROME_PATH:-}" ]; then
            echo "Chrome binary not found in $PUPPETEER_CACHE_DIR"
            echo "Directory tree for debugging:"
            ls -R "$PUPPETEER_CACHE_DIR" || true
            exit 1
          fi
          echo "PUPPETEER_EXECUTABLE_PATH=$CHROME_PATH" >> "$GITHUB_ENV"
          echo "Using Chrome at: $CHROME_PATH"
      - name: A11y smoke
        run: yarn pa11y-ci --threshold 5 --config chromeLaunchConfig.json --reporter json "$E2E_BASE_URL" > pa11y-report.json

      - name: Upload a11y report
        if: ${{ always() && hashFiles('pa11y-report.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: a11y-report
          path: pa11y-report.json
          if-no-files-found: "ignore"

      # --- E2E Tests ---
      # Cache browsers to save time
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        run: yarn playwright install --with-deps

      - name: Run e2e tests
        env:
          # Enable GitHub annotations via Playwright config gating (isCI)
          CI: true
        run: yarn e2e

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload Playwright traces (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: |
            test-results/**/*.zip
            test-results/**/*.trace
          if-no-files-found: "ignore"
          retention-days: 14

      # --- Unit Tests ---
      - name: Run unit tests
        run: yarn test

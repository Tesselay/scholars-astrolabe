name: Tests

on:
  push:
  pull_request:

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ASTRO_TELEMETRY_DISABLED: 1
      E2E_BASE_URL: "http://127.0.0.1:4321"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn
        run: corepack enable

      # Cache Yarn artifacts (Yarn Berry)
      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
            .yarn/unplugged
            .yarn/build-state.yml
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      # --- Build + Serve dist ---
      - name: Build site
        run: yarn build

      - name: Serve dist
        run: yarn astro preview --host 127.0.0.1 --port 4321 &

      - name: Wait for server
        run: yarn wait-on -t 5m http://127.0.0.1:4321

      # --- Link checker on the built HTML ---
      - name: Link checker
        uses: lycheeverse/lychee-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >-
            --no-progress
            --verbose
            --max-retries 2
            --max-concurrency 10
            --base "http://127.0.0.1:4321"
            "dist/**/*.html"
          fail: true

      # --- A11y ---
      - name: Cache Puppeteer browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-puppeteer-

      - name: Install Chrome for Testing (Pa11y/Puppeteer)
        run: yarn dlx @puppeteer/browsers install chrome@stable

      - name: Export Chrome path for Puppeteer
        run: |
          CHROME_PATH="$(find ~/.cache/puppeteer -type f -name chrome -path '*/chrome-linux*/chrome' -print -quit)"
          if [ -z "$CHROME_PATH" ]; then
            echo "Chrome binary not found in ~/.cache/puppeteer"; exit 1
          fi
          echo "PUPPETEER_EXECUTABLE_PATH=$CHROME_PATH" >> "$GITHUB_ENV"
          echo "Using Chrome at: $CHROME_PATH"

      - name: A11y smoke
        run: yarn pa11y-ci --threshold 5 --config chromeLaunchConfig.json --reporter json http://127.0.0.1:4321/ > pa11y-report.json

      - name: Upload a11y report
        if: ${{ always() && hashFiles('pa11y-report.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: a11y-report
          path: pa11y-report.json
          if-no-files-found: "ignore"

      # --- Playwright Tests ---
      # Cache browsers to save time
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        run: yarn playwright install --with-deps

      - name: Run Playwright tests
        env:
          # Enable GitHub annotations via Playwright config gating (isCI)
          CI: true
        run: yarn playwright test

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload Playwright traces (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: |
            test-results/**/*.zip
            test-results/**/*.trace
          if-no-files-found: "ignore"
          retention-days: 14